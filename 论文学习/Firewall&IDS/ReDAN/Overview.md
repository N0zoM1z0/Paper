### **论文核心思想**

该研究揭示并验证了一种针对NAT网络的、分两步实施的远程拒绝服务攻击（ReDAN） 。攻击者可以在不处于目标本地网络的情况下，首先识别出互联网上的NAT设备，然后远程终止经过该NAT设备的所有TCP连接，从而对整个NAT后的网络造成拒绝服务 。研究通过大量实验证明，该漏洞在现实世界的各种NAT设备和网络中广泛存在 。



### **核心攻击流程**

攻击分为两个主要步骤：识别NAT设备和执行DoS攻击 。



#### **第一步：利用PMTUD边信道识别NAT设备**

攻击者利用了NAT规范中对路径最大传输单元发现（PMTUD）机制考虑不周而产生的一个根本性边信道（side channel） 。



1. **攻击原理**：

   - PMTUD机制允许一个主机（如客户端）动态发现其到目标服务器路径上的最大传输单元（MTU）。当路径上有路由器的MTU小于数据包大小时，该路由器会丢弃包并返回一个ICMP "Fragmentation Needed" 消息，告知源主机需要减小包大小 

     。

   - 该研究发现，当一个NAT设备存在时，其自身生成的ICMP数据包（如ping回复）和其转发的内部客户端的TCP数据包，虽然共享同一个公网IP地址，但它们的路径MTU值可能是不同步的 

     。

2. **识别过程** ：

   

   

   - 

     改变客户端PMTU

     ：攻击者的服务器（“Vantage Point”）在收到客户端（可能是NAT后的，也可能是独立的公网主机）的TCP连接请求后，会伪造一个中间路由器的IP，向该客户端的公网IP发送一个ICMP "Fragmentation Needed" 消息，强制要求一个较小的MTU值（例如，

     ```
     mtu_x
     ```

     ） 

     。客户端收到后，会更新其为该服务器保留的PMTU值，后续发送的TCP包都会遵守这个较小的

     ```
     mtu_x
     ```

      

     。

   - 

     观察响应差异

     ：随后，攻击者向该客户端的公网IP发送一个大的ICMP Ping请求包（例如1500字节） 

     。

     - 

       如果对方是独立主机

       ：该主机的IP层已经更新了PMTU为

       ```
       mtu_x
       ```

       ，因此它在回复这个大的Ping包时，会将其分片成多个小于或等于

       ```
       mtu_x
       ```

       的IP分片 

       。

     - 

       如果对方是NAT客户端

       ：Ping请求由NAT设备接收并回复 

       。而之前攻击者发送的ICMP "Fragmentation Needed" 消息被NAT设备转发给了内部客户端，只改变了内部客户端的PMTU，并未改变NAT设备自身的PMTU 

       。因此，NAT设备会直接回复一个未分片的、大的ICMP Ping回复包（例如1500字节） 

       。

   - 

     判定

     ：通过观察ICMP Ping回复包的大小和分片情况，攻击者就能准确判断出目标公网IP背后是一个独立的IP主机还是一个NAT设备 

     。

#### **第二步：通过移除NAT映射表项实施DoS攻击**

在识别出NAT设备后，攻击者利用了许多真实世界的NAT设备对TCP RST包验证不严格的漏洞来发起攻击 。



1. **攻击原理**：

   - 许多NAT设备在收到TCP RST（重置连接）包时，为了性能考虑，不会严格检查包内的序列号是否在对应TCP连接的有效窗口内，就直接移除其NAT映射表中的会话条目 

     。

2. **攻击过程** ：

   

   

   - 

     移除NAT映射

     ：攻击者伪装成受害服务器的IP地址，向已识别的NAT设备公网IP发送大量精心构造的TCP RST包 

     。这些RST包的目的端口（即客户端的源端口）可以在一个典型范围内进行扫描（如32768-61000） 

     ，而序列号可以是任意值 

     。当RST包的端口号猜中一个有效的TCP连接时，脆弱的NAT设备会直接移除该连接的映射条目，而内部客户端因为序列号错误会直接丢弃此RST包 

     。

   - 

     操纵TCP状态

     ：移除映射后，攻击者伪装成NAT设备的公网IP，向受害服务器发送大量TCP PUSH/ACK包 

     。当包的源端口与服务器上已建立的连接匹配时，服务器会认为收到了乱序包，并根据快速重传机制回复一个“重复ACK”包 

     。这个“重复ACK”包内包含了服务器期望收到的、

     正确的序列号

      

     。

   - 

     终止TCP连接

     ：这个带有正确序列号的“重复ACK”包到达NAT设备。由于此时NAT设备已经没有该连接的映射，它会认为这是一个无效的包，并根据TCP规范，向受害服务器回复一个RST包 

     。关键在于，这个由NAT设备发出的RST包会复制收到的“重复ACK”包中的

     正确序列号

      

     。当受害服务器收到这个带有正确序列号的RST包后，会立即终止相应的TCP连接 

     。最终，当内部客户端再次发送数据时，服务器已关闭连接，也会向客户端发送RST包，导致客户端也终止连接，从而完成DoS攻击 

     。

### **漏洞影响范围和评估**

研究表明，ReDAN攻击的影响非常广泛。

- 实验室评估

  ：

  - 测试了8种路由器固件，其中6种存在漏洞；测试了14个厂商的30款商业NAT路由器，其中29款存在漏洞 

    。

  - 即使是某些原生操作系统（如FreeBSD和旧版Linux内核）中的NAT实现也存在此漏洞 

    。

- 真实世界评估

  ：

  - 在11个月内，通过部署在全球的7个“Vantage Point”服务器，成功识别了分布在全球124个国家、1289个自治系统（AS）中的超过7600个NAT设备 

    。

  - 对180个真实的NAT网络（包括90个4G LTE/5G网络、60个公共Wi-Fi网络和30个云VPS网络）进行了测试，发现其中166个（超过92%）容易受到ReDAN攻击 

    。

- 

  攻击成本

  ：攻击者只需大约5.72MBps的带宽，就可以成功阻断一个脆弱NAT设备后的所有客户端与远程SSH服务器的连接 

  。

### **讨论与对策**

- **影响**：该攻击不仅影响传统的IPv4 NAT，还对IPv6环境下的NAT技术（如NAT64, NAT66）同样有效 。各种NAT类型，如运营商级NAT（CGNAT）、源NAT（SNAT）和目的NAT（DNAT），只要其实现存在漏洞，都可能受到影响 。

  

  

- **对策** ：

  

  

  1. 

     修复PMTUD边信道

     ：建议增强NAT规范，要求NAT设备在将ICMP "Fragmentation Needed"消息转发给内部客户端的同时，也必须根据该消息同步更新自身的PMTU值 

     。这可以确保来自同一公网IP的所有类型数据包的PMTU值保持一致，从而消除信息泄露的边信道 

     。

  2. 

     对TCP进行更严格的检查

     ：NAT设备必须对收到的TCP控制包（尤其是RST包）进行更严格的合法性校验 

     。具体而言，在移除会话映射之前，必须验证RST包中的序列号是否落在对应TCP连接的接收窗口之内 

     。研究团队在OpenWrt 22.03上实现的原型证明了该对策的有效性 

     。

该研究团队已向IETF、受影响的操作系统社区、路由器固件厂商和互联网服务提供商（ISP）负责任地披露了这些漏洞，并获得了多个CVE/CNVD编号 。